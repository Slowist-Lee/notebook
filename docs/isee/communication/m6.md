# Analog - Digital Conversion

## A-D 转换 (Analog-to-Digital Conversion)

### 3.2 量化 (Quantization)

采样之后，我们得到了一系列在时间上离散的点，但每个点的幅值还是连续的。量化就是要把这些连续的幅值数字化。

**量化的两个步骤**:
1.  **步骤1**: 用有限个离散的数值来代表连续的幅值范围。即把整个纵轴分成若干个“台阶”。
2.  **步骤2**: 为每个“台阶”（量化电平）分配一个唯一的二进制码。

#### 3.2.1 均匀量化 (Uniform Quantization)

最简单的量化方式就是把信号的整个动态范围（最大值到最小值的区间）划分成 $L$ 个**等宽**的区域。

![|500](Pasted%20image%2020251116100405.png)

*   **动态范围 (Dynamic Range)**: 信号幅值的变化范围，从 $x_{min}$ 到 $x_{max}$。
*   **量化电平数 (Number of quantization levels)**: $L$。如果用 $b$ 个比特来表示一个采样符号，那么 $L = 2^b$。比特数 $b$ 越多，量化就越精细。
*   **步长 (Step size)** $\Delta$: 每个量化区间的宽度。
    $\Delta = \frac{x_{max} - x_{min}}{L}$
*   **量化门限 (Quantization threshold)**: $x_0, x_1, x_2, ...$ 这些是划分量化区间的边界值。
*   **量化规则 (Midriser)**: 如果一个采样值 $s_0$ 落在区间 $(x_i, x_{i+1}]$ 内，那么它的量化值 $\hat{s}_0$ 就被指定为这个区间的**中点值**，即 $\hat{s}_0 = x_i + \Delta/2$。
    *   **Midriser**: 阶梯状的输入-输出函数，原点处是阶梯的“竖直”部分（riser）。

> [!NOTE] Midriser 型量化器
> 其输入输出关系图如下所示，是一个阶梯函数。
> 
> ![|500](Pasted%20image%2020251116100445.png)

> [!EXAMPLE] 例题1: Midriser 量化器
>
> **问题**: 一个信号 $x(t)$ 的动态范围是 (-4, 4) V，它被送入一个 **3-bit** 的 midriser 量化器。
> 1.  画出其传输函数（输入-输出关系图）。
> 2.  确定输入值为 **0.15V** 和 **-3.1V** 时的量化值。
>
> ---
>
> **解答**:
>
> 1.  **计算参数**:
>     *   动态范围: $x_{max} = 4$, $x_{min} = -4$
>     *   比特数 $b = 3$，所以量化电平数 $L = 2^3 = 8$。
>     *   步长 $\Delta = \frac{4 - (-4)}{8} = \frac{8}{8} = 1$ V。
>
> 2.  **确定量化区间和量化值**:
>     *   量化区间为 (-4, -3], (-3, -2], ..., (3, 4]。
>     *   对应的量化输出值为每个区间的中点：-3.5, -2.5, ..., 3.5。
>
> 3.  **画图并求解**:
>     [请在此处插入第17页的图片]
>     *   对于输入 **0.15V**: 它落在 (0, 1] 区间内，该区间的量化值为中点 **0.5V**。
>     *   对于输入 **-3.1V**: 它落在 (-4, -3] 区间内，该区间的量化值为中点 **-3.5V**。

#### 3.2.2 量化误差 (Quantization Error)

量化是一个“近似”的过程，所以必然会引入误差。

[请在此处插入第18页的图片]

*   **定义**: 量化误差 $e$ 是量化后的值 $\hat{s}_0$ 与原始采样值 $s_0$ 之间的差。
    $e = \hat{s}_0 - s_0$
*   **最大误差**: 对于 midriser 均匀量化，原始值与区间中点的最大差距是半个步长，所以最大误差是 $\Delta/2$。即 $-\Delta/2 \le e \le \Delta/2$。
*   **统计特性**: 通常我们可以把量化误差（也叫量化噪声）看作一个在 $[-\Delta/2, \Delta/2]$ 上**均匀分布**的随机变量。
    *   均值 (平均误差) $\mu_e = 0$
    *   方差 (误差功率) $\sigma_e^2 = \frac{\Delta^2}{12}$

#### 3.2.3 信噪比 (Signal-to-Quantization-Noise-Ratio, SQNR)

SQNR 是衡量量化器性能的一个重要指标，它表示信号功率与量化噪声功率的比值。

> [!IMPORTANT] SQNR 公式
>
> *   **量化误差功率**:
$\sigma_e^2 = \frac{\Delta^2}{12} = \frac{(x_{max}-x_{min})^2}{12 \cdot L^2} = \frac{(x_{max}-x_{min})^2}{12 \cdot (2^b)^2}$
>
> *   **结论**: 每增加一个比特 ($b$ 增大1)，量化误差功率会减小到原来的 1/4。**比特数越多，量化越精确**。
>
> *   **SQNR 定义**:
$SQNR = \frac{P_x}{\sigma_e^2}$
    其中 $P_x$ 是信号功率，$\sigma_e^2$ 是量化误差功率。

> [!EXAMPLE] 例题2: 正弦信号的 SQNR
>
> **问题**: 一个峰值为 $A_m$ 的正弦信号，被一个动态范围为 $(-A_m, A_m)$ 的均匀量化器量化。确定输出的 SQNR。
>
> ---
>
> **解答**:
>
> 1.  **信号功率 $P_x$**: 正弦信号的平均功率是峰值平方的一半。
$P_x = A_m^2 / 2$
>
> 2.  **量化噪声功率 $\sigma_e^2$**: 动态范围是 $x_{max}-x_{min} = A_m - (-A_m) = 2A_m$。
$\sigma_e^2 = \frac{(2A_m)^2}{12 \cdot (2^b)^2} = \frac{4A_m^2}{12 \cdot 2^{2b}} = \frac{A_m^2}{3 \cdot 2^{2b}}$
>
> 3.  **计算 SQNR**:
$SQNR = \frac{P_x}{\sigma_e^2} = \frac{A_m^2 / 2}{A_m^2 / (3 \cdot 2^{2b})} = \frac{3}{2} \cdot 2^{2b} = 1.5 \cdot 2^{2b}$
>
> 4.  **转换为分贝 (dB)**:
$SQNR_{dB} = 10\log_{10}(1.5 \cdot 2^{2b})$
$SQNR_{dB} = 10\log_{10}(1.5) + 10\log_{10}(2^{2b})$
$SQNR_{dB} = 10\log_{10}(1.5) + 2b \cdot 10\log_{10}(2)$
$SQNR_{dB} \approx 1.76 + 2b \cdot 3.01 \approx 1.8 + 6b$
>
> > [!SUCCESS] 经验公式
> > 对于均匀量化器，**每增加 1 bit，SQNR 大约提升 6 dB**。
> > $$SQNR(dB) \approx 1.8 + 6b$$

---

### 3.3 非均匀量化 (Non-Uniform Quantization)

均匀量化对所有幅值一视同仁，但这不总是最高效的。

[请在此处插入第21页的图片]

*   **动机 (以语音信号为例)**:
    *   在语音信号中，**小幅度的采样点出现得更频繁**。
    *   小信号对噪声更敏感。一点点误差就会严重影响小信号的质量。
*   **核心思想**:
    *   给予小信号样本更高的优先级！
    *   对小幅度的信号使用**更小的量化步长**（更精细）。
    *   对大幅度的信号使用**更大的量化步长**（更粗糙）。
    *   即步长 $\Delta$ 随着信号幅度的增大而增大。

#### 3.3.1 如何实现非均匀量化

[请在此处插入第22页的图片]

直接实现非均匀的阶梯很复杂。通常采用一种等效的两步法：

1.  **非线性压缩 (Non-linear compression)**: 先对模拟信号进行一次非线性压缩。这个压缩过程会“压小”大信号，“放大”小信号。
2.  **均匀量化 (Uniform quantization)**: 对压缩后的信号进行标准的均匀量化。

> [!NOTE] μ律 (μ-law) 压缩
>
> 这是一种在北美和日本数字通信标准中广泛使用的压缩算法。
> $$ y = y_{max} \frac{\ln(1 + \mu(|x|/x_{max}))}{\ln(1+\mu)} \text{sgn}(x) $$
> *   $x$ 是输入信号, $y$ 是压缩后的输出信号。
> *   $\mu$ 是压缩参数，$\mu$ 越大，非线性程度越强。电话系统中通常使用 $\mu=255$。
> *   当 $\mu=0$ 时，该函数变为线性函数，即没有压缩。

#### 3.3.2 μ律量化的SQNR特性

[请在此处插入第23页的图片]

*   **对于弱信号 (小功率)**: μ律量化器的等效步长 $\Delta_{\mu-law}$ 比均匀量化器的 $\Delta_{uniform}$ 要小，因此μ律有**更好**的SQNR。
*   **对于强信号 (大功率)**: μ律量化器的等效步长 $\Delta_{\mu-law}$ 比均匀量化器的 $\Delta_{uniform}$ 要大，因此μ律的SQNR**更差**。

**结论**: μ律（非均匀）量化通过牺牲大信号的性能，显著提升了更常见的小信号的量化性能，使得整体的主观听感更好。

> [!EXAMPLE] 例题3: μ律量化器
>
> **问题**: 一个信号 $x(t)$ 动态范围是 (-4, 4)V，被送入一个 **3-bit μ律量化器** ($\mu=255$) 。假定 $y_{max}=x_{max}$ 且 $y_{min}=x_{min}$。确定输入端和输出端的量化门限。
>
> ---
>
> **解答**:
>
> [请在此处插入第25页的图片]
>
> 1.  **输出端是均匀的**:
>     *   μ律量化等效于先压缩再均匀量化。所以其**输出端**的量化是均匀的。
>     *   输出步长 $\Delta_{out} = \frac{4 - (-4)}{2^3} = 1$。
>     *   输出端的量化门限为：
>         $y_{th} = [-4, -3, -2, -1, 0, 1, 2, 3, 4]$
>
> 2.  **输入端是非均匀的**:
>     *   我们需要找到与输出门限 $y_{th}$ 对应的输入门限 $x_{th}$。这需要使用μ律的**反函数**。
>     *   μ律反函数为：
>         $x = \frac{x_{max}}{\mu} \left[ (1+\mu)^{|y|/y_{max}} - 1 \right] \text{sgn}(y)$
>
> 3.  **计算输入门限**:
>     *   将 $y_{th}$ 的每个值（例如 y=1, 2, 3, 4）代入上面的反函数公式，其中 $x_{max}=4, y_{max}=4, \mu=255$。
>     *   例如，当 $y=1$ 时，$x = \frac{4}{255} [(1+255)^{1/4}-1] \cdot 1 \approx 0.0471$。
>     *   当 $y=2$ 时，$x = \frac{4}{255} [(1+255)^{2/4}-1] \cdot 1 \approx 0.2353$。
>     *   以此类推，最终得到输入端的门限为：
>         $x_{th} = [-4, -0.9882, -0.2353, -0.0471, 0, 0.0471, 0.2353, 0.9882, 4]$
>     *   可以清楚地看到，靠近0的区间非常窄，而远离0的区间非常宽，这正是非均匀量化的特点。

---

### 3.4 编码分配 (Code Assignment)

量化完成后，我们需要给每个量化电平分配一个二进制码。格雷码 (Gray Code) 是一种常用的编码方式。

[请在此处插入第26页的图片]

> [!NOTE] 格雷码 (Gray Code) 的特性
>
> 1.  **最高位是符号位**: 例如，0代表负数，1代表正数（或反之）。
> 2.  **相邻码字只差一位**: 这是格雷码最重要的特性。例如，+1的码 `110` 和 +3的码 `111` 只有一个比特不同。这可以减少在量化电平边界处发生跳变时可能产生的巨大译码错误。
> 3.  **镜像对称**: 除了符号位，正负电平的码字是镜像对称的。

[请在此处插入第27页的图片以展示格雷码生成过程]

---

## 4. A-D 与 D-A 总结

[请在此处插入第28页的图片]

### A-D 转换流程 (回顾)
1.  **采样 (Sampling)**: 将连续时间信号变为离散时间信号。
2.  **量化 (Quantization)**: 将连续幅值信号变为离散幅值信号，并分配二进制码。

### D-A 转换流程 (Digital-to-Analog Conversion)
这是A-D的逆过程，将数字比特流恢复为模拟信号。

1.  **解码 (Decoding)**: 将输入的二进制码（如 `0001101110...`）转换回对应的量化电平值（如 `0.1, -0.3, 0.2 ...`）。
2.  **脉冲生成 (Generate a pulse)**: 为每个解码出的电平值，生成一个持续时间为 $T_s$ 的平顶脉冲。这样就形成了一个阶梯状的波形。
3.  **低通滤波 (Lowpass filtering)**: 这个阶梯波形通过一个低通滤波器，滤除高频谐波成分，使其变得平滑，从而近似恢复出原始的模拟信号。


> [!QUESTION] 练习题：语音信号的数字化
>
> **问题**:
> 一个标准的电话语音信号，其频率范围为 0 到 4kHz。现对其进行数字化处理：
> 1.  采样率设置为奈奎斯特采样率的1.25倍。
> 2.  为了保证语音质量，要求量化信噪比(SQNR)至少为 30 dB。信号的动态范围为[-4, 4]，可以假设信号功率 $P_x$ 等于1。
>
> **求解**:
> (1) 计算实际的采样率 $f_s$ 是多少？
> (2) 为了达到 30 dB 的SQNR，至少需要多少比特进行量化（即 $b$ 的最小值）？
> (3) 根据(1)和(2)的结果，计算最终生成的数字信号的总比特率 $R_b$ 是多少？
>
> ---
>
> **解答**:
>
> #### (1) 求解采样率 $f_s$
>
> *   **思路**: 首先根据信号带宽确定奈奎斯特采样率，然后乘以1.25。
> *   **已知**: 信号最高频率 $B = 4 \text{ kHz}$
> *   **计算**:
>     *   奈奎斯特采样率 $f_{Nyquist} = 2B = 2 \times 4 \text{ kHz} = 8 \text{ kHz}$
>     *   实际采样率 $f_s = 1.25 \times f_{Nyquist} = 1.25 \times 8 \text{ kHz} = 10 \text{ kHz}$
>
> > [!SUCCESS] 答案 (1)
> > 实际的采样率为 **10 kHz** (或 10,000 samples/s)。
>
> ---
>
> #### (2) 求解每样本比特数 $b$
>
> *   **思路**: 从SQNR的目标值反推出量化噪声功率，再反推出量化级数 L 和比特数 b。
> *   **已知**: $SQNR_{dB} \ge 30 \text{ dB}$，$P_x=1$，动态范围 $V_{pp} = 4 - (-4) = 8$。
> *   **计算**:
>     *   首先将SQNR从dB转换回线性值:
>       $10 \log_{10}(\text{SQNR}) \ge 30 \implies \log_{10}(\text{SQNR}) \ge 3 \implies \text{SQNR} \ge 1000$
>     *   根据SQNR定义: $\frac{P_x}{\sigma_e^2} \ge 1000 \implies \sigma_e^2 \le \frac{P_x}{1000} = \frac{1}{1000} = 0.001$
>     *   根据量化噪声功率公式: $\sigma_e^2 = \frac{\Delta^2}{12} = \frac{(V_{pp}/L)^2}{12} \le 0.001$
>     *   代入 $V_{pp}=8$: $\frac{(8/L)^2}{12} \le 0.001 \implies \frac{64}{12L^2} \le 0.001$
>     *   求解 $L^2$: $L^2 \ge \frac{64}{12 \times 0.001} = \frac{64}{0.012} \approx 5333.3$
>     *   求解 L: $L \ge \sqrt{5333.3} \approx 73.03$
>     *   因为 $L$ 必须是2的整数次幂 ($L=2^b$)，所以我们需要找到满足 $2^b \ge 73.03$ 的最小整数 $b$。
>       *   $2^6 = 64$ (不够)
>       *   $2^7 = 128$ (满足)
>     *   因此，最小比特数 $b=7$。
>
> > [!SUCCESS] 答案 (2)
> > 至少需要 **7 bits** 进行量化。
>
> ---
>
> #### (3) 求解总比特率 $R_b$
>
> *   **思路**: 总比特率等于采样率乘以每样本的比特数。
> *   **已知**: $f_s = 10,000 \text{ samples/s}$，$b = 7 \text{ bits/sample}$
> *   **计算**: $R_b = f_s \times b = 10,000 \times 7 = 70,000 \text{ bits/s} = 70 \text{ kbits/s}$
>
> > [!SUCCESS] 答案 (3)
> > 最终生成的数字信号总比特率为 **70 kbits/s**。

$g_1=(1,1,1)$，$g_2=(1,0,1)$



$\bigoplus$


