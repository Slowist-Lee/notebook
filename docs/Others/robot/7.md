好的，没问题！这份笔记将为你详细拆解这个机器人轨迹规划的例子，让你能够一步步地理解和学习。

---

# EX 6-5-1 学习笔记：机器人操作空间轨迹规划

你好！欢迎学习机器人学的轨迹规划。这个例子 (EX 6-5-1) 是一个非常经典的问题，它将教会我们如何让一个机械臂的末端（比如夹爪）在三维空间中走一条直线，并计算出每个关节应该如何运动。

我们会把整个过程分解成几个简单的步骤，确保你能够跟上。

## 核心任务

我们的目标是：
1.  **规划轨迹**：让一个三自由度（3-DOF）机械臂的末端在 **操作空间** (Operational Space，也就是我们熟悉的三维笛卡尔坐标系) 中，从起始点 $P_1$ 沿着一条直线移动到终点 $P_2$。
2.  **求解关节运动**：计算出为了实现这个直线运动，机械臂的各个 **关节空间** (Joint Space) 的角速度和角度应该是多少。

---

## Part 1: 问题描述与分析

首先，我们来看看我们面对的是一个什么样的机器人和任务。

> [!NOTE] 问题设定
> - **机器人**: 一个三自由度（有三个旋转关节 $\theta_1, \theta_2, \theta_3$）的关节型机械臂。
> - **任务**: 末端执行器 (End-effector) 从起始点 $P_1=(0.1, 1, 1)$ 移动到终点 $P_2=(-1, -0.5, 1.5)$。
> - **路径**: 必须是直线。
> - **速度**: 遵循一个给定的速度曲线 (speed profile)，如下图所示。

**(请在此处插入第2页的图片)**

### 1.1 机器人参数

这些是描述机器人尺寸的固定参数：
- $L_1 = 1$
- $L_2 = 1$
- $L_3 = 1$
- $d_2 = 0.1$

### 1.2 速度曲线 $v(t)$

速度曲线 $v(t)$ 描述了末端执行器在路径上运动的 **快慢** (标量速度)，而不是方向。
- 从 $t=0$ 到 $t=0.5$ 秒，速度从0线性增加到1。
- 从 $t=0.5$ 到 $t=1$ 秒，速度从1线性减小到0。

这个速度曲线的函数表达式是：
$v(t)= \begin{cases} 2t & 0 \le t \le 0.5 \\ 2(1-t) & 0.5 < t \le 1 \end{cases}$

---

## Part 2: 操作空间 (笛卡尔空间) 的轨迹规划

在这一部分，我们的目标是得到末端执行器在 **任意时刻 t** 的 **位置 $P(t)$** 和 **速度 $V(t)$** 的数学表达式。

### 2.1 路径的“方向盘” - 单位方向向量 $\vec{K}$

我们需要一个向量来描述从 $P_1$ 到 $P_2$ 的方向。这个向量 $\vec{K}$ 不仅包含方向信息，还把时间 $t$ 和路径长度关联起来。

它的计算公式是：
$ \vec{K} = \frac{\vec{P_2} - \vec{P_1}}{p(1) - p(0)} $

- $\vec{P_2} - \vec{P_1}$ 是从起点指向终点的方向向量。
  $\vec{P_2} - \vec{P_1} = \begin{bmatrix} -1 \\ -0.5 \\ 1.5 \end{bmatrix} - \begin{bmatrix} 0.1 \\ 1 \\ 1 \end{bmatrix} = \begin{bmatrix} -1.1 \\ -1.5 \\ 0.5 \end{bmatrix}$

- $p(t)$ 是速度 $v(t)$ 对时间的积分，代表在时间 $t$ 内走过的路径长度。$p(1) - p(0)$ 就是总路径长度。
  $p(1) - p(0) = \int_0^1 v(t)dt$
  这个积分就是速度曲线图下方的三角形面积:
  $ \text{面积} = \frac{1}{2} \times \text{底} \times \text{高} = \frac{1}{2} \times 1 \times 1 = 0.5 $

现在我们可以计算 $\vec{K}$ 了：
$ \vec{K} = \frac{\begin{bmatrix} -1.1 \\ -1.5 \\ 0.5 \end{bmatrix}}{0.5} = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix} $

### 2.2 末端执行器速度 $V(t)$

$V(t)$ 是一个 **矢量**，它有大小（快慢）和方向。我们刚刚已经把方向和大小分开了：
- **大小 (快慢)** 由 $v(t)$ 决定。
- **方向** 由 $\vec{K}$ 的方向决定。

所以，末端执行器的速度向量就是：
$ V(t) = \vec{K}v(t) = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix} v(t) $

### 2.3 末端执行器位置 $P(t)$

任意时刻 $t$ 的位置 $P(t)$ 等于 **起始位置** 加上从起点 **移动的位移**。
- **起始位置**: $\vec{P_1}$
- **移动的位移**: 方向是 $\vec{K}$ 的方向，大小是 $t$ 时刻走过的路程 $p(t)$。

公式为：
$ P(t) = \vec{K}[p(t) - p(0)] + \vec{P_1} $

其中，$p(t)$ 是 $v(t)$ 的积分：
$p(t)= \begin{cases} t^2 & 0 \le t \le 0.5 \\ -t^2+2t-0.5 & 0.5 < t \le 1 \end{cases}$

因为 $p(0)=0$，所以位置公式可以简化为：
$ P(t) = \vec{K} p(t) + \vec{P_1} = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix} p(t) + \begin{bmatrix} 0.1 \\ 1 \\ 1 \end{bmatrix} $

> [!EXAMPLE] 举个例子：t=0.5s 时刻的位置和速度
> 1.  $v(0.5) = 2 \times 0.5 = 1$
> 2.  $V(0.5) = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix} \times 1 = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix}$ (此时速度最快)
> 3.  $p(0.5) = (0.5)^2 = 0.25$
> 4.  $P(0.5) = \begin{bmatrix} -2.2 \\ -3 \\ 1 \end{bmatrix} \times 0.25 + \begin{bmatrix} 0.1 \\ 1 \\ 1 \end{bmatrix} = \begin{bmatrix} -0.55 \\ -0.75 \\ 0.25 \end{bmatrix} + \begin{bmatrix} 0.1 \\ 1 \\ 1 \end{bmatrix} = \begin{bmatrix} -0.45 \\ 0.25 \\ 1.25 \end{bmatrix}$
> 这正好是路径的中点，符合预期！

---

## Part 3: 雅可比矩阵 (Jacobian Matrix) - 连接的桥梁

我们现在知道了末端在笛卡尔空间怎么动，但还不知道机器人的关节要怎么转。**雅可比矩阵 $J$** 就是连接 **关节速度 $\dot{q}$** 和 **末端速度 $\dot{X}$** 的桥梁。

$ \dot{X} = J(q) \dot{q} $

- $\dot{X}$: 末端执行器的速度 (在我们这里就是 $V(t)$)。
- $\dot{q}$: 关节的速度 (在我们这里是 $\dot{\theta}(t) = [\dot{\theta_1}, \dot{\theta_2}, \dot{\theta_3}]^T$)。
- $J(q)$: 雅可比矩阵，它是一个函数，值取决于当前的关节角度 $q$ (或 $\theta$)。

**(请在此处插入第3页的图片)**

雅可比矩阵是通过对机器人正运动学方程求导得到的。对于我们这个机器人，PPT上已经给出了结果：

> [!TIP] 雅可比矩阵
> $J = \begin{bmatrix} d_2c_1 - l_3s_1c_{23} - l_2s_1c_2 & c_1(l_3c_{23} - l_2s_2) & l_3c_1c_{23} \\ d_2s_1 + l_3c_1c_{23} + l_2c_1c_2 & s_1(l_3c_{23} - l_2s_2) & l_3s_1c_{23} \\ 0 & l_3s_{23} + l_2c_2 & l_3s_{23} \end{bmatrix}$
>
> **符号说明**:
> - $c_1 = \cos(\theta_1)$
> - $s_1 = \sin(\theta_1)$
> - $c_{23} = \cos(\theta_2 + \theta_3)$
> - $s_{23} = \sin(\theta_2 + \theta_3)$
> ... 以此类推。

这个矩阵看起来很复杂，但别担心，我们使用它的时候，只需要在特定关节角度下把它算出来就行。

---

## Part 4: 求解关节空间轨迹 (核心步骤)

现在，我们要用雅可比矩阵来反向求解关节的速度。这就是所谓的 **速度逆运动学 (Inverse Velocity Kinematics)**。

### 4.1 核心公式

我们从 $\dot{X} = J(q) \dot{q}$ 出发，两边同时左乘雅可比矩阵的逆 $J^{-1}$：
$J^{-1}\dot{X} = J^{-1}J(q)\dot{q}$
$\dot{q} = J^{-1}(q)\dot{X}$

换成我们这个例子的符号：
$\dot{\theta}(t) = J^{-1}(\theta)V(t)$

这个公式告诉我们：只要知道 **当前时刻的关节角度 $\theta(t)$** 和 **末端速度 $V(t)$**，我们就能算出 **当前时刻关节应该转多快 $\dot{\theta}(t)$**。

### 4.2 数值迭代求解法

由于 $J$ 依赖于不断变化的 $\theta$，我们无法一次性解出整个运动过程。所以我们采用一种“步进”的数值迭代方法。就像玩游戏一样，我们一帧一帧地计算机器人的动作。

我们需要选择一个很小的时间步长，比如 $\Delta t = 0.01$ 秒。然后从 $t=0$ 开始，一步步计算到 $t=1$。

> [!IMPORTANT] 迭代求解算法流程
>
> **第0步：初始化**
> 1.  **初始关节角度 $\theta(t_0)$**: 我们需要知道 $t=0$ 时刻的关节角度。这需要通过 **逆运动学** 求解 $P_1=(0.1, 1, 1)$ 得到。这里我们假设已经求得初始角度 $\theta(t_0)$。
> 2.  设置当前时间 $t_k = 0$。
>
> **第k步：循环计算 (从 k=0, 1, 2... 直到 $t_k \ge 1$)**
>
> 1.  **获取当前状态**:
>     - 当前关节角度为 $\theta(t_k)$。
>     - 当前时间为 $t_k$。
>
> 2.  **计算操作空间速度 $V(t_k)$**:
>     - 根据时间 $t_k$ 计算标量速度 $v(t_k)$。
>     - 计算速度向量 $V(t_k) = \vec{K} v(t_k)$。
>
> 3.  **计算雅可比矩阵 $J(\theta(t_k))$**:
>     - 将当前的关节角度 $\theta_1(t_k), \theta_2(t_k), \theta_3(t_k)$ 代入Part 3中的雅可比矩阵公式，得到一个具体的 $3 \times 3$ 的数值矩阵。
>
> 4.  **求雅可比矩阵的逆 $J^{-1}(\theta(t_k))$**:
>     - 对上一步得到的数值矩阵求逆。
>
> 5.  **计算关节角速度 $\dot{\theta}(t_k)$**:
>     - 使用核心公式：$\dot{\theta}(t_k) = J^{-1}(\theta(t_k)) V(t_k)$。
>     - 这会得到一个包含三个角速度 $[\dot{\theta_1}, \dot{\theta_2}, \dot{\theta_3}]^T$ 的向量。
>
> 6.  **更新下一时刻的关节角度 $\theta(t_{k+1})$** (数值积分):
>     - 我们用当前的角度和刚算出的角速度，来估算一小段时间 $\Delta t$ 之后的角度。这叫做 **欧拉法 (Euler method)**。
>     - 公式: $\theta(t_{k+1}) \approx \theta(t_k) + \dot{\theta}(t_k) \Delta t$
>
> 7.  **更新时间**:
>     - $t_{k+1} = t_k + \Delta t$。
>
> 8.  **重复**:
>     - 回到第1步，用新的角度 $\theta(t_{k+1})$ 和新的时间 $t_{k+1}$ 继续计算，直到时间达到或超过1秒。

通过这个循环，我们就得到了一系列离散的关节角度点 $\theta(t_0), \theta(t_1), \theta(t_2), ...$，这些点连起来就构成了整个运动过程中关节的轨迹。同时，我们也得到了一系列的关节角速度 $\dot{\theta}(t_0), \dot{\theta}(t_1), ...$。

---

## 总结

让我们回顾一下整个流程：

1.  **定义笛卡尔路径**: 确定起点 $P_1$、终点 $P_2$ 和速度曲线 $v(t)$。
2.  **推导笛卡尔轨迹**: 计算出方向向量 $\vec{K}$，并写出任意时刻的末端位置 $P(t)$ 和速度 $V(t)$ 的表达式。
3.  **建立速度关系**: 利用雅可比矩阵 $J$ 建立关节速度 $\dot{\theta}$ 和末端速度 $V$ 之间的关系: $\dot{\theta} = J^{-1}V$。
4.  **迭代求解**: 从一个已知的初始关节姿态开始，通过一个循环，在每个小时间步 $\Delta t$ 内：
    - 计算当前的 $V(t)$。
    - 计算当前的 $J(\theta)$ 并求逆。
    - 计算出关节速度 $\dot{\theta}(t)$。
    - 用 $\dot{\theta}(t)$ 更新得到下一时刻的关节角度 $\theta(t+\Delta t)$。

这个方法非常强大，因为它不仅适用于直线，也适用于任何可以在笛卡尔空间中描述的复杂曲线轨迹。希望这份笔记对你有所帮助！