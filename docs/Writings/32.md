# PKU HPC Game - Write Up
 
## 零、配置 `hpcgame cli`

下载 cli https://github.com/hpcgame/hpcgame-kube-cli/releases

使用命令 https://hpcgame.pku.edu.cn/org/2df8f692-0316-4682-80cd-591732b1eda6/contest/e8ee3e65-0bc9-4122-82c0-e5be2614dbd1/problem/d38c6829-c067-4c0c-8a21-329fd6f7ff3a 

## 小北问答

主要参考了 [AI 的回答](docs/draft/0.md)

选择题应该是ABDE

4.2

查API https://learn.microsoft.com/zh-cn/message-passing-interface/mpi-cart-create-function

```c
int MPIAPI MPI_Cart_create(
        MPI_Comm              comm_old,
        int                   ndims,
        _In_count_(ndims) int *dims,
        _In_count_(ndims) int *periods,
        int                   reorder,
  _Out_ MPI_Comm              *comm_cart
);
```

```c
MPI_Cart_create(MPI_COMM_WORLD, 2, dims, periods, 1, &comm_cart);
```


> [!question]- UB 互联
> > 📝 **答题格式**：填三个数
> 
> 在高性能计算系统中，集合通信（Collective Communication）的性能主要受**带宽（Bandwidth）** 与**延迟（Latency）** 两个因素制约。
> 
> NVIDIA 通过 NVLink 与 NVSwitch 构建 GPU 间的高速 Scale-up 互联网络，而华为则提出了 **Unified Bus（UB）协议**，作为面向 NPU 的统一互联与内存访问机制。UB 协议基于华为自研的 UB Switch 交换芯片，并通过高带宽物理链路 **HCCS（High-Capacity Coherent System）** 进行连接。
> 
> 传统 AI 集群通常以 8 卡服务器为基本单元进行 Scale-out 扩展，而华为在 **CloudMatrix 384（CM384）** 架构中，通过两级 UB Switch 组网，将 **384 颗昇腾 910C NPU** 构建为一个统一的超节点（SuperPod）。在该超节点范围内，所有 NPU 均处于同一个低延迟的轨道优化网络中，实现全对等 Scale-up 互联。
> 
> CM384 进一步将 UB 网络划分为 **7 个**相互独立的物理平面。每颗 NPU 的 7 个 HCCS 接口分别接入不同的交换平面，从而保证大规模并行通信过程中，数据流在物理路径上完全隔离、无链路冲突。
> 
> ### 问题
> 
> 在 CloudMatrix 384 的标准满配部署方案中，为了支撑 384 颗昇腾 910C NPU 实现无收敛、全对等的 Scale-up 互联，系统采用两级交换架构。在该超节点的物理拓扑中，分别使用了：
> 
> - `336` 个 Level 1 UB Switch
> - `112` 个 Level 2 UB Switch
> - 最终实现了理论上 `150528` GB/s 的系统级聚合带宽
> 
> > 💡 _假设 switch chip 提供的单个 Port 可以提供 28GB/s 的通信带宽_


{"q1_1":"10","q1_2":"9.1","q2":"B: 代码存在数据竞争，结果不确定","q3_1":"8","q3_2":"7","q3_3":"2","q3_4":"1","q4_1":"MPI_Allgather(&local_val, 1, MPI_INT, recv_buf, 1, MPI_INT, MPI_COMM_WORLD);","q4_2":"MPI_Cart_create(MPI_COMM_WORLD, 2, (int[]){2,2}, (int[]){1,1}, 1, &comm_cart);","q5":"0.6","q6":"AEF","q7":"BDEF","q8_1":"18","q8_2":"1","q8_3":"96","q9_1":"336","q9_2":"112","q9_3":"75264","q10_1":"D: 100% - 严重 Cache Thrashing，每次读取都是 Miss","q10_2":"C: 子块 8 行映射到 8 个不同 Set（间隔 8），子块计算期间不会自我冲突"}